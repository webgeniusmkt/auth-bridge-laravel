# ü§ñ AI Collaboration Playbook

## Purpose
This file defines the conventions, responsibilities, and resources used by all AI assistants in this repository.

For any app functionality, see the [Product Requirements Document (PRD)](../docs/app-prd.md) and [README.md](../README.md).

We have the laravel-app-template at ../laravel-app-template/ which is a GitHub template from which one can create a new app repository and from the new repository run ./install.sh to create a new app with Laravel + Inertia + Svelte. This auth-bridge-laravel package is used to add authentication to the app with composer update rockstoneaidev/auth-bridge-laravel. The authentication calls the Auth API at ../auth-api/. The test app I've created from laravel-app-template is at ../refinepress/.

---

## Directory Overview

| Path | Purpose |
|------|----------|
| `/ai/` | AI coordination files (this location) |
| `/ai/workflows/` | Technical discussion notes, implementation plans, and decision records generated by AI |
| `/ai/logs/` | Summaries and temporary notes written by assistants |
| `/ai/rules/` | Custom `.windsurf` rules and configuration |
| `/docs/` | Human-authored documentation |
| `/docs/requirements/` | Development standards and conventions |
| `/.windsurf/` | Windsurf system configuration, rules, and runtime files (auto-managed)

---

## Active Agents

- **Claude** ‚Üí Symbolic link to this file (`CLAUDE.md ‚Üí ai/AGENTS.md`)
- **Gemini** ‚Üí Symbolic link to this file (`GEMINI.md ‚Üí ai/AGENTS.md`)
- **Codex** ‚Üí Symbolic link to this file (`AGENTS.md ‚Üí ai/AGENTS.md`)
- **Windsurf** ‚Üí Reads `.windsurf/rules/` and writes workflow reports into `/ai/workflows/`

All agents must follow the conventions and reference deeper requirements as described below.

---

## Framework

**Backend:**
- **Laravel**: 12.x
- **PHP**: 8.4
- **MySQL**: 8.x
- **Redis**: 8.2.x
- **Composer**: 2.8.x
- **Laravel Passport** ‚Äì OAuth2 authentication for API access  
- **spatie/laravel-permission** ‚Äì Role and permission management  

**Testing:**
- **Pest**: 4.x

**Dev Environment:**
- **Laravel Sail (Docker)** for local development  
- **GitHub Actions** for CI/CD  
- **Redis** for caching and queue management  

**Utilities & Code Quality:**
- **laravel/pint** ‚Äì Code style enforcement  
- **pestphp/pest** ‚Äì Testing framework  
- **Codacy** ‚Äì Code quality and security analysis

**Important Notes:**
- Use Context7 MPC to get the correct documentation for the active stack (Laravel, PHP, etc.). See [Context7 MPC](../docs/requirements/context7-mpc.md)
- Use Codacy MPC to enforce quality and security standards. See [Codacy Check & Fix](../docs/requirements/codacy-check-and-fix.md)
- All API endpoints use **Laravel Passport** for token-based authentication (no Sanctum).  
- Ensure PHP extensions for `openssl`, `mbstring`, and `pdo_mysql` are enabled.  
- Vite handles all frontend asset compilation.

## Core Conventions

### 1. Project Management & Task Tracking

This project uses **GitHub Issues** and **GitHub Projects** for task management.

**GitHub Project Board**: Access the "Projects" tab in this repository to view column definitions and automation rules.

**Available Tools:**
- **GitHub CLI (`gh`)**: Manage issues, project items, PRs, and repository interactions directly from the terminal
- **GitHub Automations**: Column transitions, labels, and notifications managed through project workflows

**Task Workflow:**
1. Use `gh issue list --state open --assignee @me` to review assigned issues and confirm their current status.
2. When starting work, assign the issue to yourself (if not already) and move its project card to `In Progress` via `gh project item-edit` or the GitHub web UI.
3. Use `gh` CLI for all git operations (branch creation, commits, PRs).
4. Reference the GitHub issue number in commit messages: `Fixes #123: Description`.
5. Create the PR with `gh pr create`, including `Fixes #123` in the description so it auto-links and closes the issue when merged.
6. Add a technical summary as a comment on the GitHub issue using `gh issue comment 123 --body "..."`.
7. Move the issue to the `In Review` or `Done` column once the PR is ready or merged.

**Git Operations (via GitHub CLI):**

Always use GitHub CLI (`gh`) commands for git operations that it supports. For other operations, use `git` commands:

```bash
# Set default repository (only needed once per session)
gh repo set-default owner/repository-name

# Create branch
git checkout -b feature/123-description

# Commit with GitHub issue reference
git commit -m "Fixes #123: Brief description

Detailed changes:
- Point 1
- Point 2

Issue: https://github.com/owner/repository-name/issues/123"

# Push and create PR
git push origin feature/123-description
gh pr create --title "Fixes #123: Feature name" \
  --body "Fixes #123\n\nDescription..." \
  --web
```

**GitHub Issue Operations (via `gh`):**

Before starting work:
- `gh issue list --assignee @me --state open`
- `gh issue view 123` to read description, acceptance criteria, and discussion
- `gh project item-edit` or the web UI to set the project status to `In Progress`

During work:
- `gh issue comment 123 --body "Progress update..."`
- `gh issue edit 123 --add-label "status:Blocked"` if you need help or are blocked

After completion:
- `gh issue comment 123 --body "Technical summary..."`
- Move the card to `In Review` or `Done` and close the issue with `gh issue close 123`
- Ensure the PR description includes `Fixes #123` so the issue auto-closes on merge

**Commit Message Format:**
```
Fixes #123: Brief imperative description (50 chars or less)

More detailed explanation (72 chars per line):
- What changed
- Why it changed
- Any implications

Issue: https://github.com/owner/repository-name/issues/123
```

### 2. API Development

**Controllers, Requests & Resources:**
When generating or modifying API controllers:
‚Üí See [Creating API Controllers](../docs/requirements/creating-api-controllers.md)
‚Üí Follow [Pagination, Sorting & Filtering](../docs/requirements/pagination-in-controllers.md) when returning list endpoints.

**Controller Quick Reference:**
- Controllers: `app/Http/Controllers/Api/v1/{FeatureName}Controller.php`
- Requests: `app/Http/Requests/{ControllerName}/{Action}Request.php`
- Resources: `app/Http/Resources/{ControllerName}/{ControllerName}Resource.php`

**Error Handling:**
- Use proper HTTP status codes using Illuminate\Http\Response (Response::HTTP_OK, Response::HTTP_CREATED, Response::HTTP_NOT_FOUND, etc. instead of hard coded numbers like 200, 201, 404, etc.)
- Return consistent JSON error responses
- Log exceptions appropriately
- Never expose sensitive error details to API responses

**Enums:**
- See [Creating Enums](../docs/requirements/creating-enums.md)

**Enums Quick Reference:**
- Enums: `app/Enums/{FeatureName}/{EnumName}.php`
- Validation Rules: `Rules\Enum\{Feature}/{EnumName}Rule.php`

### 3. Request Validation

Always define validation logic in `app/Http/Requests/{ControllerName}/...`

Never use inline validation in controllers.

‚Üí See [Validation & Requests](../docs/requirements/validation-and-requests.md)

### 4. Resources & Transformation

Use `app/Http/Resources/{ControllerName}/...` for all data formatting.

‚Üí See [Resources & Transformers](../docs/requirements/resources-and-transformers.md)

### 5. Code Style

- Follow PSR-12 and Laravel conventions
- Avoid inline queries ‚Äî use Eloquent scopes or repositories
- Use type hints for all method parameters and return types
- Write descriptive variable and method names
- Keep methods focused and single-purpose

### 6. Testing

**Framework**: This project uses **Pest** for testing (not PHPUnit syntax). Use command `pest` (alias in alias.sh for `vendor/bin/pest`) to run tests.

**Test Structure:**
- Write tests for all new features
- Place unit tests in `tests/Unit/`
- Place feature tests in `tests/Feature/`
- Follow AAA pattern: Arrange, Act, Assert

**Pest Syntax Example:**
```php
it('creates a user successfully', function () {
    // Arrange
    $data = ['name' => 'John', 'email' => 'john@example.com'];
    
    // Act
    $response = post('/api/v1/users', $data);
    
    // Assert
    $response->assertStatus(201);
    expect(User::count())->toBe(1);
});
```

‚Üí Use `it()` and `test()` functions, not PHPUnit's class-based approach
‚Üí Use `expect()` for assertions when possible
‚Üí Use `beforeEach()` and `afterEach()` for setup/teardown

## Testing Guidelines
Write feature tests for every endpoint under `tests/Feature/{Feature}/{Action}Test.php` and unit tests for pure services under `tests/Unit`. Cover happy paths, validation failures, and authorization edges, asserting on HTTP status codes and JSON structure. Maintain coverage at or above 80%.

### 7. Documentation

**When to create README.md:**
- Any new feature directory with complex logic
- New service classes or packages
- Custom implementations that aren't self-explanatory

**README.md should include:**
- Purpose and overview
- Usage examples
- Dependencies
- Configuration (if applicable)

### 8. AI Workflow Notes

**What goes in `/ai/workflows/`:**
- Technical implementation plans (e.g., "How we'll implement feature X")
- Architecture decision records
- Complex problem-solving discussions between AI and developer
- Multi-step implementation strategies

**What does NOT go in `/ai/workflows/`:**
- Actual source code (goes in appropriate `/app` directories)
- Human-written documentation (goes in `/docs`)
- Simple task checklists (use GitHub issue comments instead)

**Example workflow documents:**
- `event-driven-completion-tracking-plan.md` ‚úÖ
- `authentication-architecture-decisions.md` ‚úÖ
- `simple-todo-list.md` ‚ùå (use GitHub issue comments)
- `UserController.php` ‚ùå (use `/app/Http/Controllers`)

Never write new Markdown files in the project root unless specifically requested.

---

## Working with GitHub Projects + GitHub CLI

### Starting a Task

**Prompt Example:**
```
I'm ready to work. Please:
1. Show my assigned GitHub issues in the Todo column
2. Get full details for issue #[ID]
3. Create a feature branch for it
4. Move the issue to In Progress
5. Summarize what needs to be built
```

### During Development

Make changes following project conventions, then:

```
I've made changes for issue #123. Please:
1. Review what I've changed
2. Commit with proper GitHub issue reference
3. Add a progress comment to the GitHub issue
```

### Completing a Task

```
Issue #123 is complete. Please:
1. Review all changes
2. Create a PR with gh cli using proper format
3. Add technical summary to the GitHub issue
4. Update project status to In Review
```

---

## Notes for AI agents like Windsurf, Claude, Gemini and Codex

- Prefer creating a `README.md` in any new feature directory with complex logic
- Avoid writing new Markdown files in the project root
- Store implementation plans and technical discussions under `/ai/workflows/`
- Use GitHub Issues/Projects to track work and communicate status
- You have access to GitHub CLI (`gh`) ‚Äî use it for all git operations and project updates
- Always reference GitHub issue IDs in commits (e.g., `Fixes #123`)
- Follow the conventions in `/docs/requirements/` for all code generation
- Always keep GitHub issues updated when starting or completing work
- Write tests using Pest syntax (it/test functions, expect assertions)
- When in doubt, ask for clarification rather than making assumptions
- Windsurf executes workflows from /.windsurf/workflows/. Documents under /ai/workflows/ are for planning/discussion and are not executed by Windsurf.

---

## Security & Configuration Tips
Never commit `.env` files or secrets; rely on environment-specific configuration and cache settings in production. Rotate API keys through infrastructure tooling and document any new secrets in the internal runbook. Use factories and seeders to provision sample data‚Äîavoid hard-coded credentials or identifiers.

---

## Quick Reference: Common Commands

### Laravel Sail
The app uses Docker containers for infrastructure on local machine. There is an alias.sh file that you can run with source alias.sh to use short commands like sail (for ./vendor/bin/sail), a (for ./vendor/bin/sail artisan) and run tests with pest (for ./vendor/bin/pest). All artisan commands should be run with `sail artisan` instead of `php artisan`.

Assume the app server, redis and DB is running locally. You should not have to start with `sail up -d` or `docker-compose up -d`, unless you find a connection issue and maybe have to restart the servers with `sail down`.

### GitHub Issues & Projects
```
gh issue list --state open --assignee @me
gh issue view 123
gh issue comment 123 --body "Status update"
gh issue edit 123 --add-label "status:In Progress"
gh project item-edit --project <id> --item 123 --field "Status" --value "In Review"
```

### GitHub CLI
```bash
gh repo view                    # View current repository
gh repo set-default            # Set default repository (one-time setup)
gh pr create --web             # Create PR and open in browser
gh pr list --author @me        # List my PRs
gh pr view 123                 # View PR details
gh pr status                   # Check PR status
```

### Pest Testing
```bash
php artisan test               # Run all tests
php artisan test --filter=UserTest  # Run specific test
php artisan test --parallel    # Run tests in parallel
```

---

## Important Additional Resources

- [GitHub CLI Manual](https://cli.github.com/manual/)
- [GitHub Projects Documentation](https://docs.github.com/en/issues/planning-and-tracking-with-projects/learning-about-projects/about-projects)
- [Creating API Controllers](../docs/requirements/creating-api-controllers.md)
- [Validation & Requests](../docs/requirements/validation-and-requests.md)
- [Resources & Transformers](../docs/requirements/resources-and-transformers.md)
- [Pest Documentation](https://pestphp.com)

---

_Last updated: 2025-10-23_
